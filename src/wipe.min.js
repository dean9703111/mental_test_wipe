/*
 * canvas 1.0
 * A simple, canvas CanvasRenderingContext2D.prototype 原型扩展库，便于链式操作；
 * from wbh5.com @Author leiroc
 * Copyright 2015, MIT License
 *
 */
function Wipe(t){this.opts={el:"#wipe",fg:"#ccc",size:10,debug:!1,autoWipe:!1,data:[],onswiping:function(t,i){}};for(var i in t)this.opts[i]=t[i];this.init()}window.requestNextAnimationFrame=function(){var t=void 0,i=void 0,e=void 0,n=0,s=navigator.userAgent,o=0,a=this;return window.webkitRequestAnimationFrame&&(i=function(t){void 0===t&&(t+=new Date),a.callback(t)},t=window.webkitRequestAnimationFrame,window.webkitRequestAnimationFrame=function(i,n){a.callback=e,t(i,n)}),window.mozRequestAnimationFrame&&(o=s.indexOf("rv:"),-1!=s.indexOf("Gecko")&&(n=s.substr(o+3,3),"2.0"===n&&(window.mozRequestAnimationFrame=void 0))),window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,i){var e,n;window.setTimeout(function(){e=+new Date,t(e),n=+new Date,a.timeout=1e3/60-(n-e)},a.timeout)}}(),window.cancelAnimate=function(t){return window.cancelAnimationFrame(t)},function(t){t.drawRect=function(t,i,e,n,s,o){return"fill"==o?(this.fillStyle=s+"",this.fillRect(t,i,e,n)):"stroke"==o?(this.strokeStyle=s+"",this.strokeRect(t,i,e,n)):"round"==o||alert("type 参数错误"),this},t.clear=function(t,i,e,n){return this.clearRect(t,i,e,n),this},t.roundRect=function(t,i,e,n,s,o,a){return this.beginPath(),this.moveTo(t,i+o),this.lineTo(t,i+n-o),this.quadraticCurveTo(t,i+n,t+o,i+n),this.lineTo(t+e-o,i+n),this.quadraticCurveTo(t+e,i+n,t+e,i+n-o),this.lineTo(t+e,i+o),this.quadraticCurveTo(t+e,i,t+e-o,i),this.lineTo(t+o,i),this.quadraticCurveTo(t,i,t,i+o),"fill"==a?(this.fillStyle=s+"",this.fill()):"stroke"==a&&(this.strokeStyle=s+"",this.stroke(),this.closePath()),this},t._arc=function(t,i,e,n,s,o,a,h,r){return this.beginPath(),this.arc(t,i,e,n,s,o),a&&this.lineTo(a.x,a.y),"fill"==r?(this.fillStyle=h+"",this.fill()):"stroke"==r&&(this.strokeStyle=h+"",this.stroke(),this.closePath()),this},t.triangle=function(t,i,e,n,s){return this.beginPath(),this.moveTo(t,i),this.lineTo(e.x1,e.y1),this.lineTo(e.x2,e.y2),"fill"==s?(this.fillStyle=n+"",this.fill()):"stroke"==s&&(this.strokeStyle=n+"",this.lineTo(t,i),this.stroke(),this.closePath()),this},t.drawImg=function(t,i,e,n,s){var o=this,a=new Image;return a.onload=function(){o.drawImage(a,i,e,n,s)},a.src=t,this},t.lineW=function(t){return this.lineWidth=t,this},t._save=function(){return this.save(),this},t._moveTo=function(t,i){return this.moveTo(t,i),this},t._stroke=function(){return this.stroke(),this},t._lineTo=function(t,i){return this.lineTo(t,i),this},t.bPath=function(){return this.beginPath(),this},t.cPath=function(){return this.closePath(),this},t.sStyle=function(t){return this.strokeStyle=t,this},t._gco=function(t){return this.globalCompositeOperation=t,this},t._lineJoin=function(t){return this.lineJoin=t,this},t._lineCap=function(t){return this.lineCap=t,this}}(CanvasRenderingContext2D.prototype),Wipe.prototype={doc:document,$:function(t){return this.doc.querySelector(t)},init:function(){var t=this,i=window.devicePixelRatio||1;this.devicePixelRatio=i,this.wrap=this.$(this.opts.el),this.wrap.innerHTML=null,this.wrap.appendChild(this.doc.createElement("canvas")),this.wrapWidth=parseInt(this.wrap.offsetWidth),this.wrapHeight=parseInt(this.wrap.offsetHeight),this.wrap.addEventListener("touchmove",function(t){t.preventDefault()}),this.canvas=this.wrap.childNodes[0],this.canvas.style.cssText+="width: 100%; height: 100%",this.ctx=this.canvas.getContext("2d"),this.canvas.setAttribute("width",this.wrapWidth*i),this.canvas.setAttribute("height",this.wrapHeight*i),this.cWidth=this.canvas.width,this.cHeight=this.canvas.height,this.ctx.scale(i,i),this.pixels=Math.floor(this.cWidth*this.cHeight),this.drawFg(),this.setEvent(),this.opts.autoWipe&&setTimeout(function(){t.autoWipe()},100),this.path=[]},reset:function(t){this.ctx._gco("source-over"),this.drawFg(t),this.path=[]},winTcanvasXY:function(t,i,e){var n=t.getBoundingClientRect();return{x:i-n.left,y:e-n.top}},clear:function(){this.ctx.clear(0,0,this.cWidth,this.cHeight)},drawFg:function(t){(this.opts.fg||t)&&("#"===this.opts.fg.charAt(0)||t&&"#"===t.charAt(0)?this.ctx.drawRect(0,0,this.cWidth,this.cHeight,this.opts.fg||t,"fill"):/png|jpg|jpeg/.test(this.opts.fg)&&this.ctx.drawImg(this.opts.fg,0,0,this.wrapWidth,this.wrapHeight))},wipeStart:function(t,i,e){if(void 0!=i){e.startTime=+new Date;var n,s;if(e.opts.autoWipe)n=i.x,s=i.y;else{var o=e.winTcanvasXY(e.canvas,i.touches[0].pageX,i.touches[0].pageY);n=o.x,s=o.y,e.startTime+2e4<e.endTime?e.path=[]:(e.path.push("pause"),e.path.push(o))}t._gco("destination-out")._lineJoin("round")._lineCap("round").sStyle(this.opts.color).lineW(this.opts.size),t.bPath()._arc(n,s,this.opts.size/2,0,2*Math.PI,!0,null,this.opts.color,"fill").cPath(),t.bPath()._moveTo(n,s)}},wipeMove:function(t,i,e){var n,s;if(void 0!=i){if(e.opts.autoWipe)n=i.x,s=i.y;else{var o=e.winTcanvasXY(e.canvas,i.touches[0].pageX,i.touches[0].pageY);n=o.x,s=o.y,e.path.push(o)}t._lineTo(n,s)._stroke()}},wipeEnd:function(t,i,e){e.endTime=+new Date,t.cPath(),e.opts.onswiping.call(e,e.wipePercent(e),JSON.stringify(e.path),JSON.stringify(e.path.slice(e.path.lastIndexOf("pause")))),e.opts.debug&&console.log(JSON.stringify(e.path))},setEvent:function(){var t=this,i=this.ctx;this.canvas.addEventListener("touchstart",function(e){t.wipeStart(i,e,t)}),this.canvas.addEventListener("touchmove",function(e){t.wipeMove(i,e,t)}),this.canvas.addEventListener("touchend",function(e){t.wipeEnd(i,e,t)})},wipePercent:function(t){try{var i;i=t?t:this;for(var e=0,n=i.ctx.getImageData(0,0,i.cWidth,i.cHeight),s=0,o=n.data.length;o>s;s+=4)0===n.data[s]&&0===n.data[s+1]&&0===n.data[s+2]&&0===n.data[s+3]&&e++;return e/i.pixels*100}catch(a){console.log(a)}},similar:function(t,i){for(var e=t.length,n=(i.length,0),s=0;e>s;s++)(t[s].x==i[s].x||t[s].x<=i[s].x+1||t[s].x<=i[s].x-1)&&(t[s].y==i[s].y||t[s].y<=i[s].y+1||t[s].y<=i[s].y-1)&&n++;return Math.floor(n/e*100)},autoWipe:function(t){function i(){h++,e=requestNextAnimationFrame(i),"pause"===o[h]?(n.wipeEnd(s,o[h],n),++h<a?n.wipeStart(s,o[h],n):cancelAnimate(e)):a>h?n.wipeMove(s,o[h],n):h>=a-1&&(cancelAnimate(e),n.wipeEnd(s,o[a-1],n))}var e,n=this,s=this.ctx,o=t||n.opts.data,a=o.length,h=0;for(o.forEach(function(t){n.path.push(t)});a>h&&"pause"===o[h];)h++;a>h&&(n.wipeStart(s,o[h],n),requestNextAnimationFrame(i))}};
